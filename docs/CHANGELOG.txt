CHANGELOG

Cambios presentados el 2021/01/22
---------------------------------
Se establece una estructura de código básica para poder cargar diferentes
pantallas, poder administrar recursos (sprites individuales, atlas de imágenes,
música, efectos sonoros...), seguir al personaje con la cámara y capturar los
gestos con los que se mueve al personaje.


Cambios presentados el 2021/01/23
---------------------------------
Se plantea un mecanismo básico de cargado de niveles recibiendo una instancia
de una clase `Level`.

Se introducen los actores WallActor y FanActor. El primero representa un muro
de dimensiones múltiples de 32 píxeles, que se utilizará para las paredes de
los niveles, mientras que el segundo representa una ventilador en marcha.

PlayerActor gestiona ahora también las colisiones con estos dos nuevos elementos,
siendo consciente además de su nivel de salud y pudiendo morirse.

Para evitar invocar al recolector de basura dentro de lo posible durante la
partida, se utilizan fondos (pools) para las clases Rectangle y Array. Esto
implica la creación de cuatro clases nuevas (dos por cada clase con fondo) y,
ante la previsión de que se necesitarán añadir aún más en el futuro, se ha
designado un package propio para ellas.

Finalmente, el package principal se ha renombrado de com.example.testgame a
com.colegiovivas.lapandemia, y la clase MyTestGame se ha renombrado a
LaPandemia.


Cambios presentados el 2021/01/24
---------------------------------
Se implementa la capacidad de hacer zoom hacia dentro y hacia fuera mediante el
gesto pinch. Se añaden medidas explícitamente para que no se interprete
erróneamente que el usuario desea realizar el gesto tap si levanta uno de los
dedos antes que el otro durante el zoom, para evitar que el zoom cambie mientras
los dedos estén quietos y para que siga sin poder observarse la zona fuera de
rango del mapa.


Cambios presentados el 2021/01/25
---------------------------------
Se añade un primer modelo de virus como actor. Tal y como se especificó en el
anteproyecto, su movimiento consiste en un píxel de desplazamiento hacia alguna
de las cuatro direcciones posibles por cada llamada a act(). Esta clase de
movimiento resulta no ser tan buena idea, por lo que se cambiará a otra clase
de movimiento aleatorio menos caótica.

Hasta el momento, el único actor que necesitaba comprobar sus colisiones con
otros actores era PlayerActor, y la lógica con la que se obtenía información
como con qué actores se colisionaría tras un desplazamiento o las coordenadas
finales en las que el actor quedaría tras la colisión estaba contenida dentro
del propio PlayerActor. Ya que muchos de los mismos problemas surgen ahora para
VirusActor, el código relevante se mueve a una nueva clase, denominada
CollisionInfo, que ambos actores utilizan y que, tras inicializarse, almacena
información sobre una colisión. Para evitar instanciar esta clase múltiples
veces por renderizado, se prepara un fondo.

Algunos fondos como CollisionInfo utilizan recursos como Arrays que se deben
liberar en reset() y, por tanto, reinicializar tras la llamada a obtain().
Para hacer este proceso cómodo y simple, se implementa una función init() en
cada objeto que implementa Poolable, que hace las preparaciones pertinentes y
devuelve la propia instancia. De este modo, los objetos se obtendrán siempre
no mediante .obtain() sino mediante .obtain().init(...).

Los VirusActor son otro candidato idóneo a ser gestionados mediante un fondo, ya
que deberán aparecer y desaparecer constantemente durante las partidas. Para
asegurarnos de que las instancias de VirusActor se devuelven al fondo cuando
se eliminan los virus, se sobreescribe remove() para primero liberar el
objeto.

Finalmente, se añade código en GameScreen para iniciar la partida cargada con
tres virus en posiciones predefinidas, y se establece un número de mascarillas
para el PlayerActor. Este fragmento de código solo existirá temporalmente para
hacer pruebas.

Actualmente hay algunos bugs con la gestión de los virus que serán corregidos
en los próximos commits. Concretamente:
- Parece ser posible que un virus infecte dos veces al PlayerActor. Posiblemente
  sea porque tanto el PlayerActor como el propio Virus gestionan estas colisiones.
- Cuando dos virus chocan entre sí, solo uno de los dos debe desaparecer. Sin
  embargo, actualmente se eliminan los dos.


Cambios presentados el 2021/01/25 (2)
-------------------------------------
Se corrige el bug que provocaba que la colisión con un virus contabilizase
múltiples veces. Se debía a que CollisionPool.reset no restauraba el valor
de player a null, lo que hacía que, tras entrar un virus en colisión con el
PlayerActor, este evento también fuera reportado falsamente en las futuras
llamadas a init().


Cambios presentados el 2021/01/25 (3)
-------------------------------------
Se cambia el movimiento de los virus para ser mucho menos caótico, aunque sigue
(y seguirá) siendo aleatorio. También se cambia cómo responden cuando chocan con
otro virus; simplemente cambian de dirección.


Cambios presentados el 2021/01/28
---------------------------------
Se empieza a utilizar StretchViewport en vez de ExtendViewport para corregir
un bug en el que se mostraban regiones fuera de límites en algunos dispositivos.

También se elimina el número máximo de virus que pueden existir en un mapa.

Se introducen los siguientes cambios, sujetos a volver a cambiar en el futuro:
- No existe actualmente un zoom máximo.
- El nivel de demostración es más complejo.


Cambios presentados el 2021/01/28 (2)
-------------------------------------
Se añaden las mascarillas como actor.


Cambios presentados el 2021/01/29
---------------------------------
Se introducen las clases ActorGenerator y GenerableActor, que ayudan a especificar
de forma concisa y sin repetición de código la generación periódica de actores.
Consecuentemente, desaparecen las clases VirusPool y MaskPool (además de que en
el futuro no tendremos que crear todavía más fondos en el package pooling solo para
este propósito), desaparecen los atributos correspondientes en la clase LaPandemia,
etc.

También se corrige como consecuencia natural un error de pérdida de memoria (memory
leak) en GameScreen#dispose, donde solo se liberaban los VirusActor pero no los
MaskActor. Tan solo es un ejemplo más de por qué haber reducido la duplicación de
código es importante.


Cambios presentados el 2021/01/29
---------------------------------
Tras observar más detenidamente el ciclo de vida de los fondos, se ha eliminado por
completo el package "pooling" a favor de crear fondos anónimos desde la clase principal
del juego. Además, la función init() se ha eliminado de donde era innecesaria, ya que
complicaba las cosas más de lo que ayudaba debido a las limitaciones del sistema
tipado de Java.

Se mueve ActorGenerator fuera de GameScreen y se establece una estructura ligeramente
distinta de packages más apropiada a cómo ha ido evolucionando el proyecto. Ahora, los
actores se encuentran en el package "actors"; los GestureListeners, en "gestures"; y
"level" pasa a llamarse "levels" por seguir la convención de utilizar el plural.


Cambios presentados el 2021/01/30
---------------------------------
Se remplaza el modo en el que se trabaja con las colisiones entre personajes por una
solución más orientada a eventos. Los actores notifican del movimiento que desean
realizar a un objeto conocido como CollisionDispatcher, que determina hasta dónde
pueden moverse, realiza el desplazamiento y notifica a los actores con los que se
haya producido una colisión del hecho mediante eventos. Con este cambio se pretende
tanto dejar de utilizar el objeto CollisionInfo (lo que ya se ha logrado) como
simplificar la manera en la que se describen las interacciones entre actores (lo
que considero que también se ha logrado con esto).

Se simplifican los constructores de los actores para recibir solo información final
como la instancia del objeto LaPandemia. Ya que algunos datos como la dirección del
personaje o el generador (para los objetos generados dinámicamente) se establecen
mediante setters, me pareció una decisión arbitraria que otra información como la
posición inicial sí estuvieran en el constructor, por lo que ahora por coherencia
ya no lo están.

Se añade el papel higiénico como nuevo actor.

Se pasa de un sistema de coordenadas de mundo reales a enteras debido a que la
detección de colisiones tal y como está planteada para este juego estaba resultando
problemática con variables float por los problemas propios de utilizar una
representación de números reales de precisión limitada donde se necesita precisión
ilimitada. Esto conlleva adaptar ligeramente la implementación del movimiento de
los virus para que sigan pudiendo moverse a lo largo del tiempo como lo hacían pese
a tener que especificar los desplazamientos en cada frame en cantidades enteras.

Se limita la cantidad máxima de virus y de papel higiénico que pueden estar
presentes en el mapa simultáneamente.


Cambios presentados el 2021/01/31
---------------------------------
Se añade un tiempo límite de vida opcional para los actores generables, configurable
desde el generador, y se establecen valores para los tres actores de ese tipo
actualmente existentes: virus, mascarillas y papel.


Cambios presentados el 2021/02/01
---------------------------------
Se detecta cuándo el valor del zoom está muy cerca del máximo y, en tal caso, se
ajusta automáticamente a este, corrigiendo así el problema de usabilidad descrito en
los comentarios de GameScreen#zoom.


Cambios presentados el 2021/02/02
---------------------------------
Se introduce el actor HealthActor, que muestra la salud del personaje en pantalla.
Está programado de forma que, si se alcanza la máxima, el sprite desaparezca al cabo
de unos instantes, hasta volver a bajar, de modo que solo aparezca ocasionalmente
para notificar al jugador de la pérdida e incremento de salud. Para que el actor no
interfiera con los actores del mundo, se empiezan a organizar los actores en dos
grupos: del mundo y de interfaz de usuario.

El sistema de detección y gestión de colisiones se hace ahora también más complejo,
ya que se ha introducido la capacidad de permitir, en función de lo que los actores
decidan individualmente entre ellos como aceptable, que los unos puedan superponerse
a los otros. Las notificaciones de colisión solo se mandan una vez, y no en cada
renderizado. Todo esto nos permite establecer que los powerups como las mascarillas
o los rollos de papel higiénico no interfieran con las trayectorias de los virus,
por ejemplo.

Se hace un primer intento de mostrar por pantalla las estadísticas de juego (rollos
de papel recolectados, tiempo...). Para ello se lleva a cabo una ligera
reorganización estructural de la clase GameScreen, que ahora trabaja con unos
viewport, stage y cámara para el mundo del juego y otros para la interfaz de usuario
que muestra estos datos a tiempo real. No obstante, no he logrado cambiar el color
de fuente a uno más oscuro y es fácil confundir los iconos de la interfaz gráfica
con los propios del mapa.


Cambios presentados el 2021/02/03
---------------------------------
Se divide estructuralmente la renderización de GameScreen en tres fases (GameStages):
la cuenta atrás, la partida y el fin. Se implementa una primera versión de la cuenta
atrás, en la que se muestra todo el mapa y se da tiempo al jugador a prepararse antes
de empezar la partida.


Cambios presentados el 2021/02/04
---------------------------------
Se introduce un sistema básico de "subpantallas" para reducir la complejidad que
GameScreen estaba alcanzando al pasar de tener que mostrar únicamente el mundo a
tener que gestionar también la vista de las estadísticas y las distintas fases del
juego (introducción, partida y final). De este modo, ahora GameScreen se encarga
únicamente de delegar en la fase de juego apropiada para cada momento, y estas
fases disponen de acceso a dichas subpantallas, que son independientes entre sí.

En el futuro se añadirán más subpantallas para mostrar una cuenta atrás antes de
empezar la partida y el menú del final de la partida una vez el jugador pierda.
Ambas subpantallas se mostrarán por encima de la pantalla del mundo, lo que es
una característica soportada por este nuevo sistema.


Cambios presentados el 2021/02/05
---------------------------------
Se implementa una subpantalla para mostrar la cuenta atrás antes de empezar la
partida.
